#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

# Pre-push hook for performance analysis and testing
echo "üöÄ Running pre-push checks for TheFreed.v1..."

# Get current branch
branch=$(git branch --show-current)
echo "üìç Current branch: $branch"

# Only run intensive checks on main branches
if [[ "$branch" == "main" || "$branch" == "master" || "$branch" == "develop" ]]; then
    echo "üß™ Running performance tests..."
    
    # Quick build test
    if ! npm run build --silent; then
        echo "‚ùå Build failed! Cannot push."
        exit 1
    fi
    
    # Quick bundle analysis
    echo "üìä Running bundle analysis..."
    timeout 60s npm run bundle:perf --silent || echo "‚ö†Ô∏è Bundle analysis timed out"
    
    # Performance audit
    echo "üîç Running performance audit..."
    timeout 120s npm run performance:audit --silent || echo "‚ö†Ô∏è Performance audit timed out"
    
    echo "‚úÖ Performance checks passed!"
else
    echo "‚è≠Ô∏è  Skipping intensive checks for feature branch: $branch"
fi

# Always check for uncommitted changes
if [ -n "$(git status --porcelain)" ]; then
    echo "‚ö†Ô∏è  You have uncommitted changes. Consider committing before pushing."
    git status --short
fi

# Check remote status
echo "üì° Checking remote status..."
git fetch --quiet 2>/dev/null || echo "‚ö†Ô∏è  Could not fetch from remote"

# Check if remote branch is ahead
if git diff HEAD..origin/$branch --quiet 2>/dev/null; then
    echo "‚úÖ Remote branch is up to date"
else
    echo "‚ö†Ô∏è  Remote branch has changes. Consider pulling before pushing."
fi

echo "‚úÖ Pre-push checks completed!"